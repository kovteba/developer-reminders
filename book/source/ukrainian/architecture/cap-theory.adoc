ifndef::imagesdir[:imagesdir: source/imgs/]

[#cap-theory]
=== CAP Theory

image::architecture/cap-theory.jpg[CAP Theorem, align="center"]

[[cap-theorem-definition]]*CAP-теорія* — це фундаментальна концепція, яка описує обмеження при проєктуванні розподілених систем. Вона була сформульована в 1999 році Еріком Брюером (Eric Brewer), а у 2002 році <<cap-theory-proof,математично доведена>>. Ця теорія особливо важлива при створенні систем Service Discovery, баз даних, кластерів та хмарних інфраструктур.

Назва CAP походить від трьох властивостей, які розподілена система може мати:

* *C (Consistency / Узгодженість)* — всі вузли системи бачать одні й ті ж дані одночасно. Тобто, після запису до системи, будь-яке подальше читання повертає саме це нове значення.
* *A (Availability / Доступність)* — кожен запит до системи отримує відповідь, навіть якщо частина вузлів недоступна.
* *P (Partition tolerance / Толерантність до розділення)* — система продовжує працювати навіть у випадку втрати зв’язку між частинами кластеру (мережевого поділу).

.Принцип вибору 2 з 3
CAP-теорема стверджує: *у розподіленій системі, яка піддається мережевим розділенням (а це неминуче в реальному світі), можна одночасно гарантувати лише дві з трьох властивостей — C, A, P.*

Це означає, що кожна система повинна робити вибір між:

* CA (узгодженість + доступність) — але без толерантності до мережевих розділень;
* CP (узгодженість + толерантність) — доступність може постраждати при збої;
* AP (доступність + толерантність) — жертвується повна консистентність.

|====
|Комбінація |Що це означає                                                                  |Приклади систем
|C + P      |Дані узгоджені, але при розділенні кластеру частина запитів буде блокуватись   |Etcd, Zookeeper, Consul
|A + P      |Система завжди відповідає, але може повертати застарілі/несинхронні дані       |Cassandra, DynamoDB
|C + A      |Можлива тільки у централізованих системах або без мережевих проблем            |СУБД без реплікації
|====

Для досягнення узгодженості (C) у розподілених системах типу CP використовуються механізми *кворуму* та *консенсусу*. Де *консенсус* — це процес, за допомогою якого вузли в системі погоджуються на певний стан або значення. *Кворум* — це мінімальна кількість вузлів, які повинні погодитися для прийняття рішення, тобто як що у кластері з 5 вузлів, кворум = 3 (тобто більшість). Якщо 3+ вузли згодні — система дозволяє запис. Інакше — ні. Наприклад Etcd, Consul та Zookeeper реалізують це через алгоритми *консенсусу*: *Raft*, *Zab* або подібні. [[cap-theorem-quorum]]Тобто, якщо кластер Consul має 5 вузлів, він може втратити 2 вузли і все ще залишатися узгодженим (3 з 5 = кворум). Але якщо втратить 3 — кворум буде втрачено, і нові записи блокуються. Залишаться тільки читання з кешу або останньої доступної копії (залежить від реалізації).

Підходи у продакшені:

|====
|Вимоги                                         |Тип системи|Приклади
|Уникати конфліктів і неточних даних            |CP         |Etcd, Zookeeper, Consul
|Гарантувати швидкий відгук за будь-яких умов   |AP         |DynamoDB, Cassandra, DNS
|Локальна централізована система                |CA (умовно)|PostgreSQL, MySQL
|====

Як висновок, *CAP-теорія* — не просто теоретична концепція, а практичний інструмент для розробників розподілених систем. Розуміння компромісів між узгодженістю, доступністю та толерантністю до розділення допомагає створювати надійні, масштабовані та ефективні системи, які відповідають вимогам сучасних застосунків.
